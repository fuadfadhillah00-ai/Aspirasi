<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¶ Kotak Aspirasi ‚Äî FEB UNRI</title>
  <style>
    :root {
      --merah: #c00;
      --putih: #fff;
      --hitam: #000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    body {
      background-color: #f8f9fa;
      color: var(--hitam);
      line-height: 1.6;
    }
    header {
      background-color: var(--merah);
      color: var(--putih);
      padding: 1rem;
      text-align: center;
    }
    nav {
      background: #eee;
      padding: 0.8rem;
      text-align: center;
    }
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: var(--merah);
      font-weight: 600;
    }
    nav a.active {
      color: var(--hitam);
      text-decoration: underline;
    }
    .container {
      max-width: 900px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: var(--putih);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }
    h1, h2 { margin-bottom: 1rem; }
    h1 { font-size: 1.8rem; }
    h2 { font-size: 1.5rem; }

    /* Form */
    label {
      display: block;
      margin: 1rem 0 0.4rem;
      font-weight: 600;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 1rem 0;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
      margin-bottom: 0;
    }
    button {
      background-color: var(--merah);
      color: var(--putih);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #a00; }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Daftar Aspirasi */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .filters button {
      background: #eee;
      color: var(--hitam);
    }
    .filters button.active {
      background: var(--merah);
      color: var(--putih);
    }
    .aspirasi-item {
      border-left: 4px solid var(--merah);
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #fafafa;
    }
    .aspirasi-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #555;
    }
    .aspirasi-kategori {
      background: var(--merah);
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      font-size: 0.8rem;
    }
    .badge-anonim {
      background: #666;
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.75rem;
      margin-left: 0.3rem;
    }

    /* Status */
    .status {
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      display: none;
    }
    .status.success { display: block; background: #d4edda; color: #155724; }
    .status.error { display: block; background: #f8d7da; color: #721c24; }

    /* Loading & Empty */
    .loading, .empty {
      text-align: center;
      padding: 2rem;
      color: #777;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì¶ Kotak Aspirasi Mahasiswa</h1>
    <p>Fakultas Ekonomi dan Bisnis ‚Äî Universitas Riau</p>
  </header>

  <nav id="nav">
    <a href="#/" id="nav-lihat" class="active">Lihat Aspirasi</a>
    <a href="#/kirim" id="nav-kirim">Kirim Aspirasi</a>
  </nav>

  <div class="container">
    <!-- HALAMAN: LIHAT -->
    <div id="page-lihat" class="page active">
      <div class="card">
        <h2>üì¨ Daftar Aspirasi</h2>
        <div class="filters">
          <button class="filter-btn active" data-filter="semua">Semua</button>
          <button class="filter-btn" data-filter="dosen">Dosen</button>
          <button class="filter-btn" data-filter="tendik">Tendik</button>
          <button class="filter-btn" data-filter="fasilitas">Fasilitas</button>
          <button class="filter-btn" data-filter="kurikulum">Kurikulum</button>
          <button class="filter-btn" data-filter="lainnya">Lainnya</button>
        </div>

        <div id="aspirasi-container">
          <div class="loading">Memuat data dari spreadsheet‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- HALAMAN: KIRIM -->
    <div id="page-kirim" class="page">
      <div class="card">
        <h2>üì® Kirim Aspirasi</h2>
        <form id="form-aspirasi">
          <label for="nama">Nama Lengkap</label>
          <input type="text" id="nama" required placeholder="Contoh: Ahmad Fauzi">

          <label for="nim">NIM</label>
          <input type="text" id="nim" required placeholder="Contoh: 123456789">

          <label for="kategori">Kategori Aspirasi</label>
          <select id="kategori" required>
            <option value="">‚Äî Pilih ‚Äî</option>
            <option value="dosen">Dosen</option>
            <option value="tendik">Tenaga Kependidikan (Tendik)</option>
            <option value="fasilitas">Fasilitas Kampus</option>
            <option value="kurikulum">Kurikulum & Akademik</option>
            <option value="lainnya">Lainnya</option>
          </select>

          <label for="isi">Isi Aspirasi</label>
          <textarea id="isi" rows="6" required placeholder="Tulis aspirasimu di sini..."></textarea>

          <div class="checkbox-group">
            <input type="checkbox" id="anonymous">
            <label for="anonymous" style="display:inline;font-weight:normal;">
              Kirim secara <strong>anonymous</strong> (nama & NIM tidak ditampilkan publik)
            </label>
          </div>

          <button type="submit" id="submit-btn">Kirim Aspirasi</button>
        </form>

        <div id="status" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    // === KONFIGURASI (SUDAH DIISI SESUAI MILIKMU) ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvC_idFMawvb3g9TbvDnp4YWitI58GVAxlb6B0pB_U3Zc0NFYyKe4QBirhMcsjBIf3/exec";
    const SPREADSHEET_ID = "18NOJRSCqMbQYQ_gmZZnfmdJw0HSvgcMdePseilG2bGE";
    const SHEET_NAME = "Sheet1";

    // === STATE ===
    let currentRoute = '/';
    let aspirasiData = [];
    let currentFilter = 'semua';

    // === ROUTING ===
    function navigate(path) {
      history.pushState({ path }, '', path);
      renderRoute(path);
    }

    function renderRoute(path) {
      currentRoute = path || '/';
      document.querySelectorAll('#nav a').forEach(a => a.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

      if (path === '/' || path === '#/' || path === '' || path === '#') {
        document.getElementById('nav-lihat').classList.add('active');
        document.getElementById('page-lihat').classList.add('active');
        if (aspirasiData.length === 0) {
          fetchData();
        } else {
          renderAspirasi(currentFilter);
        }
      } else if (path.includes('/kirim')) {
        document.getElementById('nav-kirim').classList.add('active');
        document.getElementById('page-kirim').classList.add('active');
      }
    }

    window.addEventListener('popstate', () => renderRoute(location.hash || '/'));
    document.getElementById('nav-lihat').addEventListener('click', e => { e.preventDefault(); navigate('/'); });
    document.getElementById('nav-kirim').addEventListener('click', e => { e.preventDefault(); navigate('/kirim'); });

    // === KIRIM DATA ===
    document.getElementById('form-aspirasi').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const statusDiv = document.getElementById('status');

      btn.disabled = true;
      statusDiv.textContent = 'Mengirim‚Ä¶';
      statusDiv.className = 'status';

      const data = {
        nama: document.getElementById('nama').value.trim(),
        nim: document.getElementById('nim').value.trim(),
        kategori: document.getElementById('kategori').value,
        isi: document.getElementById('isi').value.trim(),
        anonymous: document.getElementById('anonymous').checked
      };

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
          statusDiv.textContent = '‚úÖ Aspirasi berhasil dikirim! Terima kasih.';
          statusDiv.className = 'status success';
          this.reset();
          document.getElementById('anonymous').checked = false;
        } else {
          throw new Error(result.message || 'Gagal mengirim.');
        }
      } catch (err) {
        statusDiv.textContent = `‚ùå Gagal: ${err.message}`;
        statusDiv.className = 'status error';
      } finally {
        btn.disabled = false;
      }
    });

    // === BACA DATA DARI SPREADSHEET ===
    async function fetchData() {
      const container = document.getElementById('aspirasi-container');
      container.innerHTML = '<div class="loading">Memuat data dari spreadsheet‚Ä¶</div>';

      try {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
        const response = await fetch(url);
        const csvText = await response.text();

        const rows = csvText.trim()
          .split('\n')
          .map(row => 
            row.split(',').map(cell => 
              cell.startsWith('"') && cell.endsWith('"') 
                ? cell.slice(1, -1).replace(/""/g, '"')
                : cell
            )
          );

        const aspirasiList = [];
        for (let i = 1; i < rows.length; i++) {
          const [ts, nama, nim, kategori, isi, anon] = rows[i];
          if (!ts || !isi) continue;

          const date = new Date(ts);
          if (isNaN(date)) continue;

          aspirasiList.push({
            timestamp: date,
            nama: nama || '',
            nim: nim || '',
            kategori: (kategori || 'lainnya').toLowerCase(),
            isi: isi || '',
            anonymous: (anon || '').trim().toLowerCase() === 'ya'
          });
        }

        aspirasiData = aspirasiList;
        renderAspirasi(currentFilter);
      } catch (err) {
        container.innerHTML = `<div class="empty">‚ùå Gagal memuat data.<br>Pastikan spreadsheet:<br>‚Ä¢ Di-set sebagai 'Siapa saja dengan link'<br>‚Ä¢ Sheet bernama 'Sheet1'</div>`;
        console.error('[Fetch Error]', err);
      }
    }

    function renderAspirasi(filter) {
      currentFilter = filter;
      const container = document.getElementById('aspirasi-container');
      let filtered = filter === 'semua' 
        ? [...aspirasiData] 
        : aspirasiData.filter(item => item.kategori === filter);

      filtered.sort((a, b) => b.timestamp - a.timestamp);

      if (filtered.length === 0) {
        container.innerHTML = `<div class="empty">Belum ada aspirasi di kategori ini.</div>`;
        return;
      }

      container.innerHTML = filtered.map(item => {
        const tgl = item.timestamp.toLocaleDateString('id-ID');
        const jam = item.timestamp.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        let namaTampil = item.anonymous ? 'üë§ Anonim' : `${item.nama} (${item.nim})`;
        if (item.anonymous) namaTampil += ` <span class="badge-anonim">anonim</span>`;

        let kategoriLabel = item.kategori;
        if (item.kategori === 'tendik') kategoriLabel = 'Tenaga Kependidikan';
        else if (item.kategori === 'fasilitas') kategoriLabel = 'Fasilitas';
        else kategoriLabel = kategoriLabel.charAt(0).toUpperCase() + kategoriLabel.slice(1);

        return `
          <div class="aspirasi-item">
            <div class="aspirasi-header">
              <strong>${namaTampil}</strong>
              <span>${tgl}, ${jam}</span>
            </div>
            <div class="aspirasi-kategori">${kategoriLabel}</div>
            <p>${item.isi.replace(/\n/g, '<br>')}</p>
          </div>
        `;
      }).join('');
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        renderAspirasi(this.dataset.filter);
      });
    });

    // Mulai
    renderRoute(location.hash || '/');
  </script>
</body>
</html>
