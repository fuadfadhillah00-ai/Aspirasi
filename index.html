<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voting Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        .vote-btn {
            padding: 10px 15px;
            margin: 0 5px;
            font-size: 16px;
        }
        .upvote-btn.active {
            background-color: #1da1f2;
            color: white;
        }
        .downvote-btn.active {
            background-color: #f91880;
            color: white;
        }
        .post {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Voting</h1>

        <!-- Form untuk menentukan ID Aspirasi -->
        <div class="form-group">
            <label for="targetAspirasiId">ID Aspirasi untuk Divote:</label>
            <input type="text" id="targetAspirasiId" placeholder="Masukkan ID Aspirasi" value="A1">
            <button onclick="loadPostData()">Load Data Aspirasi</button>
        </div>

        <!-- Status Login -->
        <div id="userStatus" style="margin-bottom: 20px;">
            <p>Status: <span id="loginStatus">Belum Login</span></p>
            <button id="loginBtn" onclick="showLogin()">Login</button>
        </div>

        <!-- Form Login -->
        <div id="loginForm" style="display: none;">
            <h3>Login untuk Voting</h3>
            <div class="form-group">
                <label for="loginNama">Nama:</label>
                <input type="text" id="loginNama" required placeholder="Nama Anda">
            </div>
            <div class="form-group">
                <label for="loginNIM">NIM:</label>
                <input type="text" id="loginNIM" required placeholder="NIM Anda">
            </div>
            <button onclick="doLogin()">Login</button>
            <button onclick="hideLogin()" style="background-color: #6c757d;">Batal</button>
        </div>

        <!-- Data Aspirasi dan Tombol Voting -->
        <div id="postDataContainer" style="display: none;">
            <h2>Aspirasi: <span id="postTitle"></span> (ID: <span id="postId"></span>)</h2>
            <div class="post-actions">
                <button class="vote-btn upvote-btn" id="upvoteBtn" onclick="handleVote('upvote')">
                    Upvote (<span id="upvoteCount">0</span>)
                </button>
                <button class="vote-btn downvote-btn" id="downvoteBtn" onclick="handleVote('downvote')">
                    Downvote (<span id="downvoteCount">0</span>)
                </button>
            </div>
            <div id="votingStatus"></div>
        </div>

        <div id="statusMessages"></div>
    </div>

    <script>
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvC_idFMawvb3g9TbvDnp4YWitI58GVAxlb6B0pB_U3Zc0NFYyKe4QBirhMcsjBIf3/exec';
        let currentUser = null;
        let currentPostData = null;
        let activeVoteRequests = new Map();

        // User Management
        function initializeUser() {
            const savedUser = localStorage.getItem('voting_test_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginStatus').textContent = `Login sebagai ${currentUser.nama} (${currentUser.nim})`;
                document.getElementById('loginBtn').textContent = 'Logout';
                return true;
            }
            return false;
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginBtn').style.display = 'none';
        }

        function hideLogin() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'inline-block';
        }

        function doLogin() {
            const nama = document.getElementById('loginNama').value.trim();
            const nim = document.getElementById('loginNIM').value.trim();

            if (!nama || !nim) {
                showStatus('Nama dan NIM harus diisi', 'error');
                return;
            }
            currentUser = { nama, nim };
            localStorage.setItem('voting_test_user', JSON.stringify(currentUser));
            document.getElementById('loginStatus').textContent = `Login sebagai ${currentUser.nama} (${currentUser.nim})`;
            document.getElementById('loginBtn').textContent = 'Logout';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'inline-block';
        }

        function doLogout() {
            currentUser = null;
            localStorage.removeItem('voting_test_user');
            document.getElementById('loginStatus').textContent = 'Belum Login';
            document.getElementById('loginBtn').textContent = 'Login';
        }

        document.getElementById('loginBtn').addEventListener('click', function() {
            if (currentUser) {
                doLogout();
            } else {
                showLogin();
            }
        });

        // Fungsi bantu
        function showStatus(message, type = 'success', elementId = 'statusMessages') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
                if (type === 'success') {
                    setTimeout(() => element.innerHTML = '', 3000);
                }
            }
        }

        // Load data untuk satu post
        function loadPostData() {
            if (!currentUser) {
                showStatus('Silakan login terlebih dahulu', 'error');
                return;
            }
            const postId = document.getElementById('targetAspirasiId').value.trim();
            if (!postId) {
                showStatus('Harap masukkan ID Aspirasi', 'error');
                return;
            }

            const timestamp = Date.now();
            const callbackName = `handlePostData_${timestamp}`;
            window[callbackName] = function(response) {
                if (response && response.success) {
                    const aspirasiData = response.data.aspirasi_counts.find(a => a.id === postId);
                    if (aspirasiData) {
                        currentPostData = aspirasiData;
                        document.getElementById('postTitle').textContent = `Post ${postId}`;
                        document.getElementById('postId').textContent = postId;
                        document.getElementById('upvoteCount').textContent = currentPostData.upvote_count;
                        document.getElementById('downvoteCount').textContent = currentPostData.downvote_count;
                        // Update user vote status berdasarkan sheet
                        const userVotes = response.data.voting.filter(v => v.id_aspirasi === postId && v.nim_user === currentUser.nim);
                        let userVoteType = null;
                        if (userVotes.length > 0) {
                            // Ambil vote terbaru
                            userVotes.sort((a, b) => new Date(b.last_updated) - new Date(a.last_updated));
                            userVoteType = userVotes[0].vote_type;
                        }
                        updateVoteButtons(userVoteType);
                        document.getElementById('postDataContainer').style.display = 'block';
                    } else {
                        showStatus(`Data untuk ID ${postId} tidak ditemukan di sheet Aspirasi.`, 'error');
                        document.getElementById('postDataContainer').style.display = 'none';
                    }
                } else {
                    console.error('Failed to load post data:', response);
                    showStatus('Gagal memuat data post', 'error');
                    document.getElementById('postDataContainer').style.display = 'none';
                }
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${APP_SCRIPT_URL}?callback=${callbackName}`;
            script.onerror = function() {
                console.error('Failed to load script for post data');
                showStatus('Gagal memuat data post (script)', 'error');
                delete window[callbackName];
            };
            document.head.appendChild(script);
        }

        function updateVoteButtons(userVoteType) {
            const upBtn = document.getElementById('upvoteBtn');
            const downBtn = document.getElementById('downvoteBtn');
            upBtn.classList.toggle('active', userVoteType === 'upvote');
            downBtn.classList.toggle('active', userVoteType === 'downvote');
        }

        // Handle voting
        async function handleVote(voteType) {
            if (!currentUser) {
                showStatus('Silakan login terlebih dahulu', 'error');
                return;
            }
            if (!currentPostData) {
                showStatus('Silakan load data post terlebih dahulu', 'error');
                return;
            }

            const postId = currentPostData.id;

            // Prevent multiple simultaneous votes
            if (activeVoteRequests.has(postId)) {
                console.log('Vote request already in progress for post:', postId);
                return;
            }

            // Set loading state
            activeVoteRequests.set(postId, true);
            document.getElementById('postDataContainer').classList.add('loading');
            const statusDiv = document.getElementById('votingStatus');
            statusDiv.innerHTML = `<div class="status">Mengirim vote...</div>`;

            try {
                const requestId = Date.now().toString();
                const formData = new FormData();
                formData.append('action', 'vote');
                formData.append('id_aspirasi', postId);
                formData.append('nim_user', currentUser.nim);
                formData.append('nama_user', currentUser.nama);
                formData.append('vote_type', voteType);
                formData.append('request_id', requestId);

                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    console.log('Server response:', result);
                    // Reload data untuk sinkronisasi
                    await loadPostData(); // Reload data post untuk update count dan status tombol
                    showStatus(`Vote berhasil ${result.action === 'REMOVED' ? 'dihapus' : 'disimpan'}!`, 'success', 'votingStatus');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Gagal menyimpan vote: ' + error.message, 'error', 'votingStatus');
            } finally {
                // Clear loading state
                activeVoteRequests.delete(postId);
                document.getElementById('postDataContainer').classList.remove('loading');
                // Status tetap ditampilkan oleh loadPostData atau error di atas
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
        });
    </script>
</body>
</html>
