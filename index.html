<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê¶ AspirasiFEB ‚Äî FEB UNRI</title>
  <style>
    :root {
      --biru: #1da1f2;
      --hitam: #0f1419;
      --abu-bg: #f7f9fa;
      --abu-border: #ccd6dd;
      --abu-teks: #536471;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: var(--abu-bg); color: var(--hitam); line-height: 1.5; }
    header {
      background: white;
      border-bottom: 1px solid var(--abu-border);
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--biru);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    label {
      display: block;
      margin: 0.75rem 0 0.3rem;
      font-size: 0.9rem;
      font-weight: 600;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--abu-border);
      border-radius: 8px;
      font-size: 1rem;
      background: #f5f8fa;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 0.75rem 0;
    }
    .checkbox-group input { width: auto; margin-right: 0.5rem; }
    
    .post-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary { background: var(--biru); color: white; }
    .btn-primary:hover { background: #0d8bd9; }
    .btn-outline { background: transparent; border: 1px solid var(--abu-border); color: var(--hitam); }
    .btn-outline:hover { background: #f0f3f5; }

    /* Postingan */
    .post {
      background: white;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--abu-border);
    }
    .post-header {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--biru);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .post-info {
      flex: 1;
    }
    .post-name {
      font-weight: bold;
      font-size: 1rem;
    }
    .post-meta {
      font-size: 0.85rem;
      color: var(--abu-teks);
    }
    .post-content {
      margin: 0.5rem 0;
      word-break: break-word;
    }
    .post-image {
      width: 100%;
      border-radius: 12px;
      margin: 0.5rem 0;
      max-height: 500px;
      object-fit: cover;
    }
    .post-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #eee;
    }
    .reply-btn {
      color: var(--abu-teks);
      background: none;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .reply-btn:hover { color: var(--biru); }

    /* Komentar */
    .replies {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px solid #f0f3f5;
    }
    .reply {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .reply-avatar { width: 32px; height: 32px; border-radius: 50%; background: #ccc; }
    .reply-content {
      flex: 1;
      background: #f7f9fa;
      padding: 0.75rem;
      border-radius: 12px;
    }
    .reply-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .reply-meta {
      font-size: 0.8rem;
      color: var(--abu-teks);
    }
    .reply-text {
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }

    .status {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: none;
    }
    .status.success { display: block; background: #d4edda; color: #155724; }
    .status.error { display: block; background: #f8d7da; color: #721c24; }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--abu-teks);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .post-actions { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span>üê¶</span>
      <span>AspirasiFEB</span>
    </div>
  </header>

  <div class="container">
    <!-- Form Kirim Aspirasi -->
    <div class="card">
      <h2>Apa aspirasimu hari ini?</h2>
      <form id="form-aspirasi">
        <label for="nama">Nama</label>
        <input type="text" id="nama" required placeholder="Contoh: Budi Santoso">

        <label for="nim">NIM</label>
        <input type="text" id="nim" required placeholder="123456789">

        <label for="kategori">Kategori</label>
        <select id="kategori">
          <option value="dosen">Dosen</option>
          <option value="tendik">Tendik</option>
          <option value="fasilitas">Fasilitas</option>
          <option value="kurikulum">Kurikulum</option>
          <option value="lainnya">Lainnya</option>
        </select>

        <label for="isi">Aspirasi</label>
        <textarea id="isi" rows="3" required placeholder="Ceritakan aspirasimu..."></textarea>

        <label for="gambar_url">URL Gambar (opsional)</label>
        <input type="url" id="gambar_url" placeholder="https://i.imgur.com/abc.jpg">

        <div class="checkbox-group">
          <input type="checkbox" id="anonymous">
          <label for="anonymous" style="font-weight: normal;">Kirim secara anonymous</label>
        </div>

        <div class="post-actions">
          <button type="button" class="btn btn-outline" onclick="location.reload()">Batal</button>
          <button type="submit" class="btn btn-primary">Posting</button>
        </div>
      </form>
      <div id="status-aspirasi" class="status"></div>
    </div>

    <!-- Daftar Aspirasi -->
    <div id="aspirasi-container">
      <div class="loading">Memuat aspirasi‚Ä¶</div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvC_idFMawvb3g9TbvDnp4YWitI58GVAxlb6B0pB_U3Zc0NFYyKe4QBirhMcsjBIf3/exec";
    let aspirasiList = [];
    let komentarList = [];

    // === FETCH DATA ===
    async function loadData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=ambil_data`);
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);
        
        aspirasiList = data.aspirasi || [];
        komentarList = data.komentar || [];
        
        renderAspirasi();
      } catch (err) {
        document.getElementById('aspirasi-container').innerHTML = 
          `<div class="card"><div class="status error">‚ùå Gagal memuat: ${err.message}</div></div>`;
      }
    }

    // === KIRIM ASPIRASI ===
    document.getElementById('form-aspirasi').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('status-aspirasi');
      const btn = e.submitter;
      
      btn.disabled = true;
      status.textContent = 'Mengirim‚Ä¶';
      status.className = 'status';

      const params = new URLSearchParams({
        action: 'kirim_aspirasi',
        nama: document.getElementById('nama').value,
        nim: document.getElementById('nim').value,
        kategori: document.getElementById('kategori').value,
        isi: document.getElementById('isi').value,
        gambar_url: document.getElementById('gambar_url').value || '',
        anonymous: document.getElementById('anonymous').checked ? 'true' : 'false'
      });

      try {
        const res = await fetch(`${SCRIPT_URL}?${params}`);
        const data = await res.json();
        
        if (data.status === 'success') {
          status.textContent = '‚úÖ Berhasil diposting!';
          status.className = 'status success';
          e.target.reset();
          document.getElementById('anonymous').checked = false;
          setTimeout(() => status.style.display = 'none', 3000);
          await loadData(); // refresh
        } else {
          throw new Error(data.message);
        }
      } catch (err) {
        status.textContent = `‚ùå ${err.message}`;
        status.className = 'status error';
      } finally {
        btn.disabled = false;
      }
    });

    // === KIRIM KOMENTAR ===
    function kirimKomentar(idAspirasi) {
      const nama = prompt("Nama Anda:");
      const nim = prompt("NIM Anda:");
      const isi = prompt("Tulis komentar:");
      if (!nama || !nim || !isi) return;

      const anonymous = confirm("Kirim secara anonymous?");

      (async () => {
        const params = new URLSearchParams({
          action: 'kirim_komentar',
          id_aspirasi: idAspirasi,
          nama,
          nim,
          isi,
          anonymous: anonymous ? 'true' : 'false'
        });

        try {
          const res = await fetch(`${SCRIPT_URL}?${params}`);
          const data = await res.json();
          if (data.status === 'success') {
            alert('‚úÖ Komentar berhasil dikirim!');
            await loadData();
          } else {
            alert('‚ùå Gagal: ' + data.message);
          }
        } catch (err) {
          alert('‚ùå Error: ' + err.message);
        }
      })();
    }

    // === RENDER ===
    function renderAspirasi() {
      const container = document.getElementById('aspirasi-container');
      
      if (aspirasiList.length === 0) {
        container.innerHTML = `<div class="card"><p class="loading">Belum ada aspirasi.</p></div>`;
        return;
      }

      // Sort terbaru
      aspirasiList.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

      container.innerHTML = aspirasiList.map(aspirasi => {
        const waktu = new Date(aspirasi.waktu);
        const tgl = waktu.toLocaleDateString('id-ID');
        const jam = waktu.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const namaTampil = aspirasi.anonymous ? 'Anonim' : aspirasi.nama;
        const inisial = (namaTampil.charAt(0) || '?').toUpperCase();

        // Filter komentar untuk aspirasi ini
        const replies = komentarList
          .filter(k => k.id_aspirasi === aspirasi.id)
          .sort((a, b) => new Date(a.waktu) - new Date(b.waktu));

        const repliesHtml = replies.map(k => {
          const ktgl = new Date(k.waktu).toLocaleDateString('id-ID');
          const kinisial = (k.anonymous ? '?' : (k.nama.charAt(0) || '?')).toUpperCase();
          return `
            <div class="reply">
              <div class="reply-avatar" style="background:#${Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')}">${kinisial}</div>
              <div class="reply-content">
                <div><span class="reply-name">${k.anonymous ? 'Anonim' : k.nama}</span> ¬∑ <span class="reply-meta">${ktgl}</span></div>
                <div class="reply-text">${k.isi}</div>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="post">
            <div class="post-header">
              <div class="avatar" style="background:#${Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')}">${inisial}</div>
              <div class="post-info">
                <div class="post-name">${namaTampil}</div>
                <div class="post-meta">${aspirasi.kategori} ¬∑ ${tgl}, ${jam}</div>
              </div>
            </div>
            <div class="post-content">${aspirasi.isi.replace(/\n/g, '<br>')}</div>
            ${aspirasi.gambar ? `<img src="${aspirasi.gambar}" class="post-image" onerror="this.style.display='none'">` : ''}
            
            <div class="post-footer">
              <button class="reply-btn" onclick="kirimKomentar('${aspirasi.id}')">
                üí¨ Balas ¬∑ ${replies.length}
              </button>
            </div>

            ${replies.length > 0 ? `<div class="replies">${repliesHtml}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Mulai
    loadData();
  </script>
</body>
</html>
