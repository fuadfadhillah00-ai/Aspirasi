<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üê¶ AspirasiFEB ‚Äî FEB UNRI</title>
  <style>
    :root {
      --biru: #1da1f2;
      --hitam: #0f1419;
      --abu-bg: #f7f9fa;
      --abu-border: #ccd6dd;
      --abu-teks: #536471;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { background: var(--abu-bg); color: var(--hitam); display: flex; height: 100vh; overflow: hidden; }

    .panel-left {
      width: 400px; background: white; border-right: 1px solid var(--abu-border); padding: 1.5rem; overflow-y: auto;
    }
    .logo { font-size: 1.5rem; font-weight: bold; color: var(--biru); margin-bottom: 1.5rem; display: flex; gap: 0.5rem; }
    .card { background: white; border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    label { display: block; margin: 0.75rem 0 0.3rem; font-weight: 600; }
    input, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--abu-border); border-radius: 8px; background: #f5f8fa; }
    .btn { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: var(--biru); color: white; margin-top: 1rem; }
    .btn:hover { background: #0d8bd9; }
    .btn:disabled { opacity: 0.6; }
    .btn-outline { background: transparent; border: 2px dashed var(--abu-border); color: var(--abu-teks); text-align: center; padding: 1.5rem; margin: 0.5rem 0; cursor: pointer; }
    .upload-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin: 0.5rem 0; display: none; }

    .panel-right { flex: 1; overflow-y: auto; background: var(--abu-bg); padding: 1rem; }
    .filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .filter-btn { padding: 0.4rem 0.8rem; border: 1px solid var(--abu-border); border-radius: 20px; background: white; cursor: pointer; font-size: 0.85rem; }
    .filter-btn.active { background: var(--biru); color: white; border-color: var(--biru); }

    .post { background: white; border-radius: 16px; padding: 1.25rem; margin-bottom: 1.25rem; border: 1px solid var(--abu-border); }
    .post-header { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--biru); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .post-info { flex: 1; }
    .post-name { font-weight: bold; font-size: 1rem; }
    .post-meta { font-size: 0.85rem; color: var(--abu-teks); }
    .post-content { margin: 0.5rem 0; word-break: break-word; line-height: 1.5; }
    .post-image { width: 100%; border-radius: 12px; margin: 0.75rem 0; max-height: 400px; object-fit: cover; }
    .post-footer { display: flex; justify-content: flex-end; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #eee; }
    .reply-btn { color: var(--abu-teks); background: none; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; font-size: 0.9rem; }
    .reply-btn:hover { color: var(--biru); }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; width: 90%; max-width: 500px; margin: 10% auto; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .modal-footer { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .modal-btn { flex: 1; padding: 0.6rem; border: none; border-radius: 6px; cursor: pointer; }
    .btn-cancel { background: #eee; color: var(--hitam); }
    .btn-submit { background: var(--biru); color: white; }
    .status { padding: 0.75rem; border-radius: 6px; margin: 0.75rem 0; font-size: 0.9rem; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .empty, .loading { text-align: center; padding: 2rem; color: var(--abu-teks); }
  </style>
</head>
<body>
  <div class="panel-left">
    <div class="logo"><span>üê¶</span><span>AspirasiFEB</span></div>
    <div class="card">
      <h2>üì¢ Tulis Aspirasimu</h2>
      <form id="form-aspirasi">
        <label for="nama">Nama Lengkap</label>
        <input type="text" id="nama" required placeholder="Contoh: Budi Santoso">
        <label for="nim">NIM</label>
        <input type="text" id="nim" required placeholder="123456789">
        <label for="isi">Aspirasi</label>
        <textarea id="isi" rows="4" required placeholder="Ceritakan aspirasimu..."></textarea>
        <div class="btn-outline" id="upload-area">üì∑ Seret atau klik (maks. 5 MB)<input type="file" id="file-input" accept="image/*" style="display:none;"></div>
        <img id="preview" class="upload-preview">
        <button type="submit" class="btn" id="btn-submit">Posting Aspirasi</button>
      </form>
      <div id="status-form" class="status" style="display:none;"></div>
    </div>
  </div>

  <div class="panel-right">
    <div class="card">
      <div class="filters">
        <button class="filter-btn active" data-filter="semua">Semua</button>
        <button class="filter-btn" data-filter="dosen">Dosen</button>
        <button class="filter-btn" data-filter="tendik">Tendik</button>
        <button class="filter-btn" data-filter="fasilitas">Fasilitas</button>
      </div>
      <div id="posts-container"><div class="loading">Memuat aspirasi‚Ä¶</div></div>
    </div>
  </div>

  <div id="modal-komentar" class="modal">
    <div class="modal-content">
      <h3>üí¨ Balas Aspirasi</h3>
      <input type="hidden" id="modal-id-aspirasi">
      <label>Nama Lengkap</label><input type="text" id="modal-nama" required placeholder="Nama Anda">
      <label>NIM</label><input type="text" id="modal-nim" required placeholder="NIM Anda">
      <label>Komentar</label><textarea id="modal-isi" rows="3" required placeholder="Tulis komentar..."></textarea>
      <div class="modal-footer">
        <button class="modal-btn btn-cancel" onclick="closeModal()">Batal</button>
        <button class="modal-btn btn-submit" onclick="submitKomentar()">Kirim</button>
      </div>
      <div id="status-modal" class="status" style="display:none;"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvC_idFMawvb3g9TbvDnp4YWitI58GVAxlb6B0pB_U3Zc0NFYyKe4QBirhMcsjBIf3/exec";
    let aspirasiList = [], komentarList = [], currentFilter = 'semua';

    // === KOMPRESI GAMBAR ‚Üí base64 murni (tanpa header) ===
    function compressAndGetBase64(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = () => {
          img.src = reader.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            let w = img.width, h = img.height;
            if (w > 800) { h = (h * 800) / w; w = 800; }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            const full = canvas.toDataURL("image/jpeg", 0.75);
            resolve(full.split(",")[1]); // hanya data base64
          };
        };
        reader.onerror = () => reject("Gagal baca file");
        reader.readAsDataURL(file);
      });
    }

    // === MASKING NAMA ===
    const maskName = nama => (nama ? `${nama.trim().charAt(0).toUpperCase()}***` : 'Anonim');

    // === INFER KATEGORI ===
    const inferKategori = isi => {
      isi = isi.toLowerCase();
      if (isi.includes('dosen') || isi.includes('mengajar')) return 'dosen';
      if (isi.includes('tendik') || isi.includes('administrasi')) return 'tendik';
      if (isi.includes('fasilitas') || isi.includes('ac') || isi.includes('lcd')) return 'fasilitas';
      return 'lainnya';
    };

    // === LOAD DATA ===
    async function loadData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=ambil_data`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        aspirasiList = data.aspirasi || [];
        komentarList = data.komentar || [];
        renderPosts();
      } catch (err) {
        document.getElementById('posts-container').innerHTML = `<div class="status error">‚ùå ${err.message}</div>`;
      }
    }

    // === DRAG & DROP ===
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      uploadArea.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(e => {
      uploadArea.addEventListener(e, () => uploadArea.style.borderColor = '#1da1f2', false);
    });
    ['dragleave', 'drop'].forEach(e => {
      uploadArea.addEventListener(e, () => uploadArea.style.borderColor = '', false);
    });
    uploadArea.addEventListener('drop', e => { e.preventDefault(); fileInput.files = e.dataTransfer.files; handleFile(); }, false);
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFile);

    function handleFile() {
      const file = fileInput.files[0];
      if (!file || !file.type.match('image.*') || file.size > 5e6) {
        if (file && file.size > 5e6) alert('‚ùå Maks 5 MB');
        fileInput.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(file);
    }

    // ‚úÖ SUBMIT VIA POST (TANPA URL PANJANG) ===
    document.getElementById('form-aspirasi').addEventListener('submit', async e => {
      e.preventDefault();
      const status = document.getElementById('status-form');
      status.textContent = 'üì§ Mengirim‚Ä¶'; status.className = 'status'; status.style.display = 'block';

      let base64Image = '';
      const file = fileInput.files[0];
      if (file) {
        status.textContent = 'üñºÔ∏è Mengompresi gambar‚Ä¶';
        try { base64Image = await compressAndGetBase64(file); } 
        catch (err) { status.textContent = `‚ùå ${err}`; status.className = 'status error'; return; }
      }

      const payload = {
        action: "kirim_aspirasi",
        nama: document.getElementById('nama').value.trim(),
        nim: document.getElementById('nim').value.trim(),
        isi: document.getElementById('isi').value.trim(),
        base64Image
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.status === "success") {
          status.textContent = '‚úÖ Berhasil!'; status.className = 'status success';
          e.target.reset(); fileInput.value = ""; preview.style.display = "none";
          setTimeout(() => status.style.display = "none", 2000);
          await loadData();
        } else throw new Error(data.message);
      } catch (err) {
        status.textContent = `‚ùå ${err.message || "Gagal kirim"}`; status.className = 'status error';
      }
    });

    // === MODAL ===
    function openKomentar(id) { document.getElementById('modal-id-aspirasi').value = id; document.getElementById('modal-komentar').style.display = 'block'; }
    function closeModal() { document.getElementById('modal-komentar').style.display = 'none'; }

    async function submitKomentar() {
      const id = document.getElementById('modal-id-aspirasi').value;
      const nama = document.getElementById('modal-nama').value.trim();
      const nim = document.getElementById('modal-nim').value.trim();
      const isi = document.getElementById('modal-isi').value.trim();
      const status = document.getElementById('status-modal');

      if (!nama || !nim || !isi) { status.textContent = '‚ö†Ô∏è Isi semua!'; status.className = 'status error'; status.style.display = 'block'; return; }

      status.textContent = 'üì§ Mengirim‚Ä¶'; status.className = 'status'; status.style.display = 'block';

      const params = new URLSearchParams({ action: 'kirim_komentar', id_aspirasi: id, nama, nim, isi });
      try {
        const res = await fetch(`${SCRIPT_URL}?${params}`);
        const data = await res.json();
        if (data.status === 'success') {
          status.textContent = '‚úÖ Sukses!'; status.className = 'status success';
          setTimeout(() => { closeModal(); loadData(); }, 1500);
        } else throw new Error(data.message);
      } catch (err) {
        status.textContent = `‚ùå ${err.message}`; status.className = 'status error';
      }
    }

    window.onclick = e => { if (e.target === document.getElementById('modal-komentar')) closeModal(); };

    // === RENDER ===
    function renderPosts() {
      const container = document.getElementById('posts-container');
      let filtered = currentFilter === 'semua' ? aspirasiList : aspirasiList.filter(a => inferKategori(a.isi) === currentFilter);
      filtered.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

      if (!filtered.length) { container.innerHTML = `<div class="empty">Belum ada aspirasi.</div>`; return; }

      container.innerHTML = filtered.map(a => {
        const t = new Date(a.waktu);
        const d = t.toLocaleDateString('id-ID'), t2 = t.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const n = maskName(a.nama), i = n.charAt(0);
        const k = { dosen: 'Dosen', tendik: 'Tendik', fasilitas: 'Fasilitas', lainnya: 'Lainnya' }[inferKategori(a.isi)];

        const replies = komentarList.filter(k => k.id_aspirasi === a.id).map(k => ({ ...k, n: maskName(k.nama), i: maskName(k.nama).charAt(0) }));
        const repliesHtml = replies.map(k => `
          <div class="reply">
            <div class="reply-avatar" style="background:#${Math.floor(Math.random()*16777215).toString(16,6)}">${k.i}</div>
            <div class="reply-content">
              <div class="reply-name">${k.n}</div>
              <div class="reply-meta">${new Date(k.waktu).toLocaleDateString('id-ID')}</div>
              <div>${k.isi}</div>
            </div>
          </div>
        `).join('');

        return `
          <div class="post">
            <div class="post-header">
              <div class="avatar" style="background:#${Math.floor(Math.random()*16777215).toString(16,6)}">${i}</div>
              <div class="post-info">
                <div class="post-name">${n}</div>
                <div class="post-meta">${d}, ${t2} ¬∑ ${k}</div>
              </div>
            </div>
            <div class="post-content">${a.isi.replace(/\n/g, '<br>')}</div>
            ${a.gambar ? `<img src="${a.gambar}" class="post-image">` : ''}
            <div class="post-footer">
              <button class="reply-btn" onclick="openKomentar('${a.id}')">üí¨ Balas ¬∑ ${replies.length}</button>
            </div>
            ${replies.length ? `<div class="replies">${repliesHtml}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderPosts();
      });
    });

    loadData();
  </script>
</body>
</html>
